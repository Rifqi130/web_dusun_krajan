<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Homepage Dusun</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <link href="style/navbar-fixed.css" rel="stylesheet" />
    <style>
      /* About Section Styling */
      .about-section .card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      }

      .about-section .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
      }

      .about-section .card-body {
        position: relative;
        overflow: hidden;
      }

      .about-section .card-body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #2c5aa0, #17a2b8, #28a745, #ffc107);
      }

      /* Responsive improvements */
      @media (max-width: 768px) {
        .about-section .card-body {
          padding: 1.5rem !important;
        }

        .about-section h4 {
          font-size: 1.1rem;
        }
      }

      /* Navbar mobile improvements */
      @media (max-width: 991px) {
        .navbar-collapse {
          background-color: rgba(255, 255, 255, 0.98);
          border-radius: 0 0 10px 10px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
          margin-top: 10px;
          padding: 1rem;
          transition: all 0.3s ease;
        }

        .navbar-nav .nav-link {
          padding: 0.75rem 1rem !important;
          border-radius: 8px;
          margin-bottom: 0.25rem;
          transition: all 0.3s ease;
        }

        .navbar-nav .nav-link:hover {
          background-color: #f8f9fa;
          color: #2c5aa0 !important;
        }

        .navbar-nav .nav-link.active {
          background-color: #2c5aa0;
          color: white !important;
        }

        .navbar-toggler {
          border: none;
          padding: 0.25rem 0.5rem;
          transition: all 0.2s ease;
        }

        .navbar-toggler:focus {
          box-shadow: none;
        }

        .navbar-toggler:hover {
          background-color: rgba(0, 0, 0, 0.05);
        }

        /* Smooth navbar collapse animation */
        .navbar-collapse.collapsing {
          transition: height 0.35s ease;
        }
      }

      /* Demografis Section */
      .demografis-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .demografis-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .demografis-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }

      .demographic-stats {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .stat-item {
        border-right: 1px solid rgba(255, 255, 255, 0.2);
      }

      .stat-item:last-child {
        border-right: none;
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
      }

      .stat-label {
        font-size: 0.95rem;
        opacity: 0.9;
      }

      /* Age Demographics Bar Chart Section */
      .age-demographics-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 20px;
        padding: 2.5rem;
        margin-top: 2rem;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(44, 90, 160, 0.1);
      }

      .age-chart-container {
        position: relative;
        height: 450px;
        margin-bottom: 2rem;
        padding: 0 10px;
      }

      .age-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
      }

      .age-stat-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .age-stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .age-stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
        color: white;
      }

      .age-stat-icon.bayi {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      }

      .age-stat-icon.balita {
        background: linear-gradient(135deg, #feca57, #ff9ff3);
      }

      .age-stat-icon.kanak {
        background: linear-gradient(135deg, #48dbfb, #0abde3);
      }

      .age-stat-icon.remaja {
        background: linear-gradient(135deg, #1dd1a1, #10ac84);
      }

      .age-stat-icon.dewasa {
        background: linear-gradient(135deg, #5f27cd, #341f97);
      }

      .age-stat-icon.lansia {
        background: linear-gradient(135deg, #fd79a8, #e84393);
      }

      .age-stat-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #2c5aa0, #1e40af);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .age-stat-label {
        color: #6b7280;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      .age-range {
        color: #9ca3af;
        font-size: 0.75rem;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .age-demographics-section {
          padding: 1.5rem;
        }

        .age-chart-container {
          height: 350px;
          padding: 0 5px;
        }

        .age-stats-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 0.75rem;
        }

        .age-stat-card {
          padding: 1rem;
        }

        .age-stat-number {
          font-size: 1.5rem;
        }

        .age-stat-icon {
          width: 40px;
          height: 40px;
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-3">
      <div class="container">
        <a class="navbar-brand fw-bold d-flex align-items-center" style="font-size: 1.5rem; letter-spacing: 0.5px">
          <span style="color: #2c5aa0">Dusun Krajan</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active px-3 py-2" href="index.html"> <i class="bi bi-speedometer2 me-1"></i>Dashboard </a>
            </li>
            <li class="nav-item">
              <a class="nav-link px-3 py-2" href="dusun/pengurus.html"> <i class="bi bi-people me-1"></i>Pengurus </a>
            </li>
            <li class="nav-item">
              <a class="nav-link px-3 py-2" href="dusun/aset.html"> <i class="bi bi-building me-1"></i>Aset Dusun </a>
            </li>
            <li class="nav-item">
              <a class="nav-link px-3 py-2" href="dusun/umkm.html"> <i class="bi bi-shop me-1"></i>UMKM </a>
            </li>
            <li class="nav-item ms-2">
              <a class="nav-link px-3 py-2 text-success fw-semibold" href="admin/loginadmin.html"> <i class="bi bi-box-arrow-in-right me-1"></i>Login </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Hero Section -->
    <section class="hero-section position-relative" style="background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80') center/cover no-repeat; height: 340px">
      <div class="container h-100 d-flex flex-column justify-content-center align-items-center text-center" style="height: 340px">
        <h1 class="display-3 fw-bold text-white mb-2" style="text-shadow: 2px 2px 8px #333">Welcome to Dusun</h1>
        <h2 class="fs-2 text-white mb-3" style="text-shadow: 2px 2px 8px #333">Krajan</h2>
      </div>
    </section>
    <!-- Main Content -->
    <main class="container py-5">
      <!-- About Dusun Krajan Section -->
      <section class="about-section mb-5">
        <div class="row">
          <div class="col-12">
            <div class="text-center mb-5">
              <h2 class="fw-bold text-primary mb-3">Tentang Dusun Krajan</h2>
              <p class="lead text-muted">Mengenal lebih dekat Dusun Krajan, pusat kehidupan masyarakat Desa Bligo</p>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <!-- Deskripsi Umum -->
          <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px">
                    <i class="bi bi-info-circle-fill fs-4"></i>
                  </div>
                  <h4 class="fw-bold ms-3 mb-0 text-primary">Deskripsi Umum</h4>
                </div>
                <p class="text-muted">
                  Dusun Krajan merupakan salah satu dari beberapa dusun yang berada di wilayah administratif Desa Bligo, Kecamatan Ngluwar, Kabupaten Magelang, Jawa Tengah. Masyarakat Dusun Krajan dikenal memiliki semangat kebersamaan dan
                  gotong royong yang tinggi. Dalam kesehariannya, warga hidup dalam suasana yang rukun, menjunjung nilai-nilai tradisi, serta aktif dalam kegiatan sosial maupun keagamaan.
                </p>
              </div>
            </div>
          </div>

          <!-- Sejarah Dusun -->
          <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px">
                    <i class="bi bi-book-fill fs-4"></i>
                  </div>
                  <h4 class="fw-bold ms-3 mb-0 text-success">Sejarah Dusun</h4>
                </div>
                <p class="text-muted">
                  Nama "Krajan" berasal dari bahasa Jawa yang berarti "pusat" atau "inti desa". Penamaan ini mengindikasikan bahwa Dusun Krajan merupakan salah satu dusun utama yang ada sejak awal berdirinya Desa Bligo. Menurut cerita dari
                  para sesepuh, daerah ini dahulu menjadi tempat tinggal tokoh-tokoh pertama yang membuka lahan dan menetap di wilayah Bligo.
                </p>
              </div>
            </div>
          </div>

          <!-- Letak Geografis -->
          <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <div class="rounded-circle bg-warning text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px">
                    <i class="bi bi-geo-alt-fill fs-4"></i>
                  </div>
                  <h4 class="fw-bold ms-3 mb-0 text-warning">Letak Geografis</h4>
                </div>
                <p class="text-muted">
                  Secara geografis, Dusun Krajan berada di bagian tengah Desa Bligo. Dusun ini memiliki akses jalan yang sudah memadai dan terhubung langsung ke jalan utama desa. Di sebelah utara berbatasan dengan Dusun Beteng, di timur
                  dengan Dusun Blaburan, di selatan dengan Dusun Cabeyan, dan di barat mengarah ke lahan pertanian serta Sungai Progo.
                </p>
              </div>
            </div>
          </div>

          <!-- Potensi Lokal -->
          <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px">
                    <i class="bi bi-tree-fill fs-4"></i>
                  </div>
                  <h4 class="fw-bold ms-3 mb-0 text-info">Potensi Lokal</h4>
                </div>
                <p class="text-muted">
                  Sektor utama yang menjadi potensi lokal Dusun Krajan adalah pertanian. Sebagian besar masyarakat bekerja sebagai petani yang menanam komoditas seperti padi, jagung, dan sayuran musiman. Lahan pertanian yang subur dan
                  dukungan sistem irigasi desa menjadi penopang utama kehidupan ekonomi masyarakat.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Demografis Section -->
      <section class="demografis-section py-5">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <div class="text-center mb-5">
                <h2 class="fw-bold mb-3">Demografis Penduduk</h2>
                <p class="lead opacity-75">Data komposisi penduduk Dusun Krajan berdasarkan jenis kelamin</p>
              </div>
            </div>
          </div>

          <div class="row justify-content-center">
            <div class="col-lg-10">
              <div class="demografis-card p-4">
                <div class="row align-items-center">
                  <div class="col-md-6">
                    <div class="chart-container">
                      <canvas id="demographicsChart"></canvas>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="demografis-info mt-4 mt-md-0">
                      <h4 class="fw-bold mb-4 text-center">Statistik Penduduk</h4>

                      <!-- Demographic Stats -->
                      <div class="demographic-stats p-4">
                        <div class="row text-center">
                          <div class="col-4 stat-item">
                            <div class="stat-number" id="maleCount">0</div>
                            <div class="stat-label">Laki-laki</div>
                          </div>
                          <div class="col-4 stat-item">
                            <div class="stat-number" id="femaleCount">0</div>
                            <div class="stat-label">Perempuan</div>
                          </div>
                          <div class="col-4 stat-item">
                            <div class="stat-number" id="totalCount">0</div>
                            <div class="stat-label">Total</div>
                          </div>
                        </div>
                      </div>

                      <!-- Additional Info -->
                      <div class="mt-4 text-center">
                        <p class="mb-2 opacity-75"><i class="bi bi-info-circle me-2"></i>Data per tahun 2025</p>
                        <p class="mb-0 opacity-75"><i class="bi bi-geo-alt me-2"></i>Dusun Krajan, Desa Bligo, KecamatanNgluwar</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Age Demographics Section -->
      <section class="age-demographics-section">
        <div class="text-center mb-4">
          <h2 class="fw-bold text-primary mb-3"><i class="bi bi-bar-chart-fill"></i> Demografis Berdasarkan Usia</h2>
          <p class="text-muted">Distribusi penduduk Dusun Krajan berdasarkan kategori usia</p>
        </div>

        <div class="row">
          <div class="col-lg-8 mx-auto">
            <div class="age-chart-container">
              <canvas id="ageChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Age Statistics Cards -->
        <div class="age-stats-grid">
          <div class="age-stat-card">
            <div class="age-stat-icon bayi">
              <i class="bi bi-heart-fill"></i>
            </div>
            <div class="age-stat-number" id="bayiCount">0</div>
            <div class="age-stat-label">Bayi</div>
            <div class="age-range">< 1 Tahun</div>
          </div>

          <div class="age-stat-card">
            <div class="age-stat-icon balita">
              <i class="bi bi-emoji-smile-fill"></i>
            </div>
            <div class="age-stat-number" id="balitaCount">0</div>
            <div class="age-stat-label">Balita</div>
            <div class="age-range">1-5 Tahun</div>
          </div>

          <div class="age-stat-card">
            <div class="age-stat-icon kanak">
              <i class="bi bi-backpack-fill"></i>
            </div>
            <div class="age-stat-number" id="kanakCount">0</div>
            <div class="age-stat-label">Kanak-kanak</div>
            <div class="age-range">6-12 Tahun</div>
          </div>

          <div class="age-stat-card">
            <div class="age-stat-icon remaja">
              <i class="bi bi-mortarboard-fill"></i>
            </div>
            <div class="age-stat-number" id="remajaCount">0</div>
            <div class="age-stat-label">Remaja</div>
            <div class="age-range">13-19 Tahun</div>
          </div>

          <div class="age-stat-card">
            <div class="age-stat-icon dewasa">
              <i class="bi bi-briefcase-fill"></i>
            </div>
            <div class="age-stat-number" id="dewasaCount">0</div>
            <div class="age-stat-label">Dewasa</div>
            <div class="age-range">20-59 Tahun</div>
          </div>

          <div class="age-stat-card">
            <div class="age-stat-icon lansia">
              <i class="bi bi-person-walking"></i>
            </div>
            <div class="age-stat-number" id="lansiaCount">0</div>
            <div class="age-stat-label">Lansia</div>
            <div class="age-range">> 60 Tahun</div>
          </div>
        </div>
      </section>
    </main>
    <footer class="bg-white text-center py-4 mt-5 border-top">
      <div class="container">
        <div class="row">
          <div class="col-md-6 text-md-start text-center mb-2 mb-md-0">
            <span class="text-muted">&copy; 2025 Dusun Kita. All rights reserved.</span><br />
            <span class="text-muted" style="font-size: 0.9em">Open Sans / Montserrat</span>
          </div>
        </div>
      </div>
    </footer>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Navbar Handler JS -->
    <script src="js/navbar-handler.js"></script>
    <!-- Demographics Sync JS -->
    <script src="js/demographics-sync.js"></script>

    <!-- Demographics Chart Script -->
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        // Initialize empty data for error state
        let demographicsData = {
          laki_laki: 0,
          perempuan: 0,
          total: 0,
          bayi: 0,
          balita: 0,
          kanak_kanak: 0,
          remaja: 0,
          dewasa: 0,
          lansia: 0,
        };

        let isDatabaseConnected = false;

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

          const response = await fetch("http://localhost:5001/pendataan/statistics", {
            signal: controller.signal,
            headers: {
              "Content-Type": "application/json",
            },
          });

          clearTimeout(timeoutId);

          if (response.ok) {
            demographicsData = await response.json();
            isDatabaseConnected = true;
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        } catch (error) {
          console.log("Database connection failed:", error);
          isDatabaseConnected = false;
          // Show error message for demographics sections
          showDemographicsError();
        }

        // Function to show error message when database is not connected
        function showDemographicsError() {
          // Show error for demographics section
          const demografisSection = document.querySelector(".demografis-section .demografis-card");
          if (demografisSection) {
            demografisSection.innerHTML = `
              <div class="alert alert-warning text-center" style="margin: 2rem;">
                <div class="mb-3">
                  <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #f0ad4e;"></i>
                </div>
                <h5><i class="bi bi-exclamation-triangle"></i> Gagal Memuat Data Demografis</h5>
                <p>Terjadi kesalahan saat memuat data demografis penduduk. Silakan coba lagi.</p>
                <p class="text-muted mb-3"><small>Pastikan database server sudah berjalan (xampp/nodemon)</small></p>
                <button class="btn btn-outline-warning" onclick="location.reload()">
                  <i class="bi bi-arrow-clockwise"></i> Coba Lagi
                </button>
              </div>
            `;
          }

          // Show error for age demographics section
          const ageSection = document.querySelector(".age-demographics-section");
          if (ageSection) {
            const ageChartContainer = ageSection.querySelector(".age-chart-container");
            const ageStatsGrid = ageSection.querySelector(".age-stats-grid");

            if (ageChartContainer) {
              ageChartContainer.innerHTML = `
                <div class="alert alert-warning text-center">
                  <div class="mb-3">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #f0ad4e;"></i>
                  </div>
                  <h5><i class="bi bi-exclamation-triangle"></i> Gagal Memuat Data Usia</h5>
                  <p>Terjadi kesalahan saat memuat data demografis berdasarkan usia.</p>
                  <p class="text-muted mb-3"><small>Pastikan database server sudah berjalan (xampp/nodemon)</small></p>
                  <button class="btn btn-outline-warning" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Coba Lagi
                  </button>
                </div>
              `;
            }

            if (ageStatsGrid) {
              ageStatsGrid.style.display = "none";
            }
          }
        }

        // Initialize chart variables
        let demographicsChart = null;
        let ageChart = null;

        // Initialize Demographics Pie Chart - only if database is connected
        if (isDatabaseConnected) {
          const ctx = document.getElementById("demographicsChart").getContext("2d");

          demographicsChart = new Chart(ctx, {
            type: "pie",
            data: {
              labels: ["Laki-laki", "Perempuan"],
              datasets: [
                {
                  label: "Jumlah Penduduk",
                  data: isDatabaseConnected ? [demographicsData.laki_laki, demographicsData.perempuan] : [0, 0],
                  backgroundColor: ["rgba(54, 162, 235, 0.8)", "rgba(255, 99, 132, 0.8)"],
                  borderColor: ["rgba(54, 162, 235, 1)", "rgba(255, 99, 132, 1)"],
                  borderWidth: 2,
                  hoverBackgroundColor: ["rgba(54, 162, 235, 1)", "rgba(255, 99, 132, 1)"],
                  hoverBorderWidth: 3,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  align: "center",
                  labels: {
                    color: "white",
                    font: {
                      size: 14,
                      weight: "bold",
                    },
                    padding: 20,
                    usePointStyle: true,
                    pointStyle: "circle",
                  },
                },
                tooltip: {
                  backgroundColor: "rgba(0, 0, 0, 0.8)",
                  titleColor: "white",
                  bodyColor: "white",
                  borderColor: "rgba(255, 255, 255, 0.3)",
                  borderWidth: 1,
                  callbacks: {
                    label: function (context) {
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((context.parsed / total) * 100).toFixed(1);
                      return context.label + ": " + context.parsed + " orang (" + percentage + "%)";
                    },
                  },
                },
              },
              animation: {
                animateRotate: true,
                animateScale: true,
                duration: 2000,
                easing: "easeOutBounce",
              },
            },
          });
        } // End of isDatabaseConnected if block

        // Update stats with animation
        function animateValue(element, start, end, duration) {
          let startTimestamp = null;
          const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            element.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
              window.requestAnimationFrame(step);
            }
          };
          window.requestAnimationFrame(step);
        }

        // Animate stats numbers with dynamic data - only if database is connected
        setTimeout(() => {
          if (isDatabaseConnected) {
            animateValue(document.getElementById("maleCount"), 0, demographicsData.laki_laki, 1500);
            animateValue(document.getElementById("femaleCount"), 0, demographicsData.perempuan, 1500);
            animateValue(document.getElementById("totalCount"), 0, demographicsData.total, 1500);
          } else {
            // Set to 0 if database not connected
            document.getElementById("maleCount").innerHTML = 0;
            document.getElementById("femaleCount").innerHTML = 0;
            document.getElementById("totalCount").innerHTML = 0;
          }
        }, 500);

        // Initialize Age Demographics Bar Chart - only if database is connected
        if (isDatabaseConnected) {
          const ageCtx = document.getElementById("ageChart").getContext("2d");

          const ageData = {
            bayi: demographicsData.bayi,
            balita: demographicsData.balita,
            kanak: demographicsData.kanak_kanak,
            remaja: demographicsData.remaja,
            dewasa: demographicsData.dewasa,
            lansia: demographicsData.lansia,
          };

          const ageChart = new Chart(ageCtx, {
            type: "bar",
            data: {
              labels: ["Bayi\n(< 1 Tahun)", "Balita\n(1-5 Tahun)", "Kanak-kanak\n(6-12 Tahun)", "Remaja\n(13-19 Tahun)", "Dewasa\n(20-59 Tahun)", "Lansia\n(> 60 Tahun)"],
              datasets: [
                {
                  label: "Jumlah Penduduk",
                  data: [ageData.bayi, ageData.balita, ageData.kanak, ageData.remaja, ageData.dewasa, ageData.lansia],
                  backgroundColor: [
                    "rgba(255, 107, 107, 0.8)", // Bayi - Red
                    "rgba(254, 202, 87, 0.8)", // Balita - Yellow
                    "rgba(72, 219, 251, 0.8)", // Kanak - Blue
                    "rgba(29, 209, 161, 0.8)", // Remaja - Green
                    "rgba(95, 39, 205, 0.8)", // Dewasa - Purple
                    "rgba(253, 121, 168, 0.8)", // Lansia - Pink
                  ],
                  borderColor: ["rgba(238, 90, 36, 1)", "rgba(255, 159, 243, 1)", "rgba(10, 189, 227, 1)", "rgba(16, 172, 132, 1)", "rgba(52, 31, 151, 1)", "rgba(232, 67, 147, 1)"],
                  borderWidth: 2,
                  borderRadius: 8,
                  borderSkipped: false,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  backgroundColor: "rgba(0, 0, 0, 0.8)",
                  titleColor: "white",
                  bodyColor: "white",
                  borderColor: "rgba(255, 255, 255, 0.3)",
                  borderWidth: 1,
                  callbacks: {
                    label: function (context) {
                      return `${context.label.split("\n")[0]}: ${context.parsed.y} orang`;
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    color: "rgba(0, 0, 0, 0.1)",
                  },
                  ticks: {
                    color: "#6b7280",
                    font: {
                      size: 12,
                    },
                  },
                },
                x: {
                  grid: {
                    display: false,
                  },
                  ticks: {
                    color: "#6b7280",
                    font: {
                      size: 9,
                    },
                    maxRotation: 0,
                    minRotation: 0,
                    autoSkip: false,
                    maxTicksLimit: 6,
                  },
                },
              },
              layout: {
                padding: {
                  bottom: 20,
                  left: 5,
                  right: 5,
                },
              },
              animation: {
                duration: 2000,
                easing: "easeOutBounce",
              },
            },
          });
        } // End of isDatabaseConnected if block for age chart

        // Animate age statistics numbers with dynamic data - only if database is connected
        setTimeout(() => {
          if (isDatabaseConnected) {
            animateValue(document.getElementById("bayiCount"), 0, demographicsData.bayi, 1500);
            animateValue(document.getElementById("balitaCount"), 0, demographicsData.balita, 1500);
            animateValue(document.getElementById("kanakCount"), 0, demographicsData.kanak_kanak, 1500);
            animateValue(document.getElementById("remajaCount"), 0, demographicsData.remaja, 1500);
            animateValue(document.getElementById("dewasaCount"), 0, demographicsData.dewasa, 1500);
            animateValue(document.getElementById("lansiaCount"), 0, demographicsData.lansia, 1500);
          } else {
            // Set all age stats to 0 if database not connected
            document.getElementById("bayiCount").innerHTML = 0;
            document.getElementById("balitaCount").innerHTML = 0;
            document.getElementById("kanakCount").innerHTML = 0;
            document.getElementById("remajaCount").innerHTML = 0;
            document.getElementById("dewasaCount").innerHTML = 0;
            document.getElementById("lansiaCount").innerHTML = 0;
          }
        }, 1000);

        // Function to refresh data (can be called when data is updated)
        window.refreshDemographicsData = async function () {
          try {
            const response = await fetch("http://localhost:5001/pendataan/statistics");
            if (response.ok) {
              const newData = await response.json();
              updateChartsWithNewData(newData);
            }
          } catch (error) {
            console.log("Error refreshing data:", error);
          }
        };

        // Function to update charts with new data
        function updateChartsWithNewData(newData) {
          // Update pie chart
          demographicsChart.data.datasets[0].data = [newData.laki_laki, newData.perempuan];
          demographicsChart.update();

          // Update bar chart
          const newAgeData = [newData.bayi, newData.balita, newData.kanak_kanak, newData.remaja, newData.dewasa, newData.lansia];
          ageChart.data.datasets[0].data = newAgeData;
          ageChart.update();

          // Update stats numbers
          animateValue(document.getElementById("maleCount"), parseInt(document.getElementById("maleCount").innerHTML) || 0, newData.laki_laki, 1000);
          animateValue(document.getElementById("femaleCount"), parseInt(document.getElementById("femaleCount").innerHTML) || 0, newData.perempuan, 1000);
          animateValue(document.getElementById("totalCount"), parseInt(document.getElementById("totalCount").innerHTML) || 0, newData.total, 1000);

          // Update age stats
          animateValue(document.getElementById("bayiCount"), parseInt(document.getElementById("bayiCount").innerHTML) || 0, newData.bayi, 1000);
          animateValue(document.getElementById("balitaCount"), parseInt(document.getElementById("balitaCount").innerHTML) || 0, newData.balita, 1000);
          animateValue(document.getElementById("kanakCount"), parseInt(document.getElementById("kanakCount").innerHTML) || 0, newData.kanak_kanak, 1000);
          animateValue(document.getElementById("remajaCount"), parseInt(document.getElementById("remajaCount").innerHTML) || 0, newData.remaja, 1000);
          animateValue(document.getElementById("dewasaCount"), parseInt(document.getElementById("dewasaCount").innerHTML) || 0, newData.dewasa, 1000);
          animateValue(document.getElementById("lansiaCount"), parseInt(document.getElementById("lansiaCount").innerHTML) || 0, newData.lansia, 1000);
        }

        // Register with demographics sync system
        if (window.demographicsSync) {
          window.demographicsSync.onDataChange(updateChartsWithNewData);
        }
      });
    </script>
  </body>
</html>
